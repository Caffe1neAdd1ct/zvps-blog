---
layout: post
title:  "Restoring a deleted logical volume"
date:   2013-02-16 02:35:06
categories: guides linux lvm
---

Today it was necessary to restore a deleted / terminated SolusVM Xen PV base VPS stored on a Logical Volume. 
This guide is primarlly written for restoring a SolusVM Xen virtual private server LV but can easily be applied to restore any Logical Volume.
Documentation seemed very scarce on this topic so here is a guide which worked fine for us, however use at your own risk and research any commands you're not sure on how to use.

<br>

![Server Logo](/img/server.png) 

<br>

**Step 1 - Secure Volume Group from LV Creations**

A SolusVM user has deleted his/her VPS, gone forever right? Incorrect, if you (the admin) acts very quickly!

1. Login to SolusVM as an administrator level user

2. Navigate to <code>Configuration</code> - <code>Settings</code> - <code>Other</code>

3. Activate <code>Import Mode</code>
This will stop any creations and deletions of logical volumes, which could potentially overwrite our "deleted" logical volume.

Great, hopefully you secured the server against lv changes quick enough.

<br>

**Step 2 - Locate the logical volume's Meta Data**

1. Next ssh to the dedicated server which the VPS's Logical Volume resides on.<br>

2. Change directory to: <code>cd /etc/lvm/archive/</code> *Note: This directory holds all the Logical Volume meta data diffs (changes)*

3. Run the <code>ls</code> command to get a list of the diffs: <code>ls -latr</code><br>You should see something similar to:<br><code>-rw------- 1 root solusvm 6159 May 27 13:37 vg_00321-1999469621.vg<br>-rw------- 1 root solusvm 6478 May 27 13:37 vg_00322-74777232.vg<br>-rw------- 1 root solusvm 6789 May 27 13:38 vg_00323-934468464.vg</code><br><br>

4. Look through these change logs to see which file was created just before the deletion command ran, 
   find the "vm123" number of the deleted VPS in SolusVM and look for it in these meta data files (use <code>vi</code> again): <code>vi vg_00317-736705785.vg</code><br>

When you find the correct "vm123" number the file content should look similar to:<br>

<code>
    # Generated by LVM2 version 2.02.88(2)-RHEL5 (2012-01-20): Sun May 27 06:01:36 2012<br>
    contents = "Text Format Volume Group"<br>
    version = 1<br>
    description = "Created *before* executing 'lvremove -f /dev/vg/vm123_img'"<br>
</code>


The diff file showing the lv before running lvremove is the key to restoring the deleted lv, for this example we will use the filename: <code>vg_00317-736705785.vg</code>

<br>

**Step 3 - Restoring the Meta Data**

Warning - restoring this data can be tricky, if this was the last change then this guide will work without issues, however if this wasn't the last change to any logical volume you will need to perform a difference change and create your own .vg file to restore the LV Meta Data.<br>

1. Run the logical volume config restore command: <code>lvm vgcfgrestore -f filename volume_group_name</code>

So replacing with our example data where the filename is <code>vg_00317-736705785.vg</code> and our Volume Group is <code>vg</code>:<br>

<code>
    lvm vgcfgrestore -f /etc/lvm/archive/vg_00317-736705785.vg vg<br>
</code>

<br>

**Step 5 - Re-activation**

1. Great we have restored the Meta Data so LVM now knows where to find the old Logical Volume on the hard drive, lets get it reactivated and registered with the Operating System again. Run the following commands:<br>
<code>lvm vgscan</code><br>
<code>lvm pvscan</code><br>
<code>lvm vgchange vg -a y</code><br>

2. The volume will now be activated again, lets scan the system again, check the output for the restored LV name:<br>
<code>lvm pvs</code><br>
<code>lvm vgs</code><br>
<code>lvm lvs</code><br>                                                            

<br>

**Step 6 - Restore the VPS in SolusVM**

1. Re-create the VPS in SolusVM with import mode turned on. You will be prompted for the old vm ID e.g vm123

2. Once re-created reboot the VPS using SolusVM, this should rewrite the Xen VPS Configuration files. If it fails to boot then try shutting it down and using the Boot button.

3. If the VPS still refuses to boot then change the Kernel from pygrub to default in SolusVM and try again. You can also try this command while booting the VPS: <code>tail -f /var/log/xen/xend.log</code>

